name: C/C++ CI for Web

on:
  push:
    branches: [ web, web_develop ]
    tags: [ v** ]
  pull_request:
    branches: [ web, web_develop ]

jobs:
  build:
    if: ${{ !contains(github.event.head_commit.message, '[ci skip]') }}
    strategy:
      matrix:
        container: [ 1.39.13-upstream, 1.39.13-fastcomp ]
    container: 
      image: trzeci/emscripten:${{ matrix.container }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Create build folder
        working-directory: Web
        run: mkdir build

      - name: Create project using cmake
        working-directory: Web/build
        run: emcmake cmake -DCMAKE_BUILD_TYPE=Release ..

      - name: Cache boost
        id: cache_boost
        uses: actions/cache@v1
        env:
          cache-name: cache-boost-headers
        with:
          path: Dependencies/boost_1_72_0/boost
          key: ${{ runner.os }}-build-${{ env.cache-name }}

      - name: Download boost
        if: ${{ !steps.cache_boost.outputs.cache-hit }}
        working-directory: Dependencies
        run: |
          git clone --recursive https://github.com/boostorg/boost.git --branch boost-1.72.0
          mv boost boost_1_72_0

      - name: Place boost
        if: ${{ !steps.cache_boost.outputs.cache-hit }}
        working-directory: Dependencies/boost_1_72_0
        run: |
          ./bootstrap.sh
          ./b2 headers
          mkdir boost_tmp
          cp -L -r boost boost_tmp
          rm -r boost
          mv boost_tmp/boost boost

      - name: Cache emscripten ports
        id: cache_emscripten_ports
        uses: actions/cache@v1
        env:
          cache-name: cache-emscripten-ports-2
        with:
          path: /emsdk_portable/.data/
          key: ${{ matrix.container }}-${{ runner.os }}-build-${{ env.cache-name }}

      - name: Prebuild emscripten ports
        if: ${{ !steps.cache_emscripten_ports.outputs.cache-hit }}
        run: |
          embuilder.py build ogg
          embuilder.py build vorbis
          embuilder.py build libpng
          embuilder.py build freetype
          embuilder.py build harfbuzz

      - name: Cache Build result
        id: cache_siv3d_library
        uses: actions/cache@v1
        env:
          cache-name: cache-siv3d-library
        with:
          path: Web/build
          key: ${{ matrix.container }}-${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('Siv3D/**/*.*') }}-${{ hashFiles('Web/CMakeLists.txt') }}

      - name: Build project
        if: ${{ !steps.cache_siv3d_library.outputs.cache-hit }}
        working-directory: Web/build
        run: cmake --build . --parallel 4 

      - name: Bundle output
        run: |
          mkdir Package
          cp -r Siv3D/include Package
          cp -r Siv3D/lib/Web Package
          cp -r Web/App/resources Package
          cp -r Web/App/example Package
          mv Package/Web Package/lib
          cp Web/build/libSiv3D.a Package/lib
          cp Web/App/Siv3D.js Package/lib
          zip -r OpenSiv3D.zip Package
          tar -cvzf OpenSiv3D.tgz Package/*

      - name: Save Bundles
        uses: actions/upload-artifact@v2
        with:
          name: OpenSiv3D-Bundles-${{ matrix.container }}
          path: OpenSiv3D.*

  build-app:
    needs: build
    container: 
      image: trzeci/emscripten:1.39.13-upstream
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Create build folder
        working-directory: Web/App
        run: mkdir build

      - name: Restore emscripten ports
        id: cache_emscripten_ports
        uses: actions/cache@v1
        env:
          cache-name: cache-emscripten-ports-2
        with:
          path: /emsdk_portable/.data/
          key: ${{ runner.os }}-build-${{ env.cache-name }}

      - name: Restore Bundles
        uses: actions/download-artifact@v2
        with:
          name: OpenSiv3D-Bundles-1.39.13-upstream
          path: .

      - name: Restore Siv3D library
        run: |
          tar -xvf OpenSiv3D.tgz
          mkdir Web/Build
          cp Package/lib/libSiv3D.a Web/Build

      - name: Create project using cmake
        working-directory: Web/App/build
        run: emcmake cmake ..

      - name: Build Siv3d App
        working-directory: Web/App/build
        run: cmake --build .

      - name: Save Bundles
        uses: actions/upload-artifact@v2
        with:
          name: Siv3D_App
          path: Web/App/build/Siv3D_App.*

  deploy:
    if: ${{ contains(github.ref, 'tags/v') }}
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Restore Bundles
        uses: actions/download-artifact@v2
        with:
          name: OpenSiv3D-Bundles-1.39.13-upstream
          path: .

      - name: Create release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}

      - name: Upload Release Asset (zip)
        id: upload-release-asset-zip
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: OpenSiv3D.zip
          asset_name: OpenSiv3D.zip
          asset_content_type: application/zip

      - name: Upload Release Asset (tgz)
        id: upload-release-asset-tgz
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: OpenSiv3D.tgz
          asset_name: OpenSiv3D.tgz
          asset_content_type: application/gzip

  build-pic:
    if: ${{ !contains(github.event.head_commit.message, '[ci skip]') }}
    container: 
      image: trzeci/emscripten:1.39.13-upstream
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Create build folder
        working-directory: Web
        run: mkdir build

      - name: Create project using cmake
        working-directory: Web/build
        run: emcmake cmake -DCMAKE_BUILD_TYPE=Release -DSIV3D_BUILD_SHARED_WASM=1 ..

      - name: Cache boost
        id: cache_boost
        uses: actions/cache@v1
        env:
          cache-name: cache-boost-headers
        with:
          path: Dependencies/boost_1_72_0/boost
          key: ${{ runner.os }}-build-${{ env.cache-name }}

      - name: Download boost
        if: ${{ !steps.cache_boost.outputs.cache-hit }}
        working-directory: Dependencies
        run: |
          git clone --recursive https://github.com/boostorg/boost.git --branch boost-1.72.0
          mv boost boost_1_72_0

      - name: Place boost
        if: ${{ !steps.cache_boost.outputs.cache-hit }}
        working-directory: Dependencies/boost_1_72_0
        run: |
          ./bootstrap.sh
          ./b2 headers
          mkdir boost_tmp
          cp -L -r boost boost_tmp
          rm -r boost
          mv boost_tmp/boost boost

      - name: Cache emscripten ports
        id: cache_emscripten_ports_pic
        uses: actions/cache@v1
        env:
          cache-name: cache-emscripten-ports-pic
        with:
          path: /emsdk_portable/.data/
          key: ${{ runner.os }}-build-${{ env.cache-name }}

      - name: Prebuild emscripten ports
        if: ${{ !steps.cache_emscripten_ports_pic.outputs.cache-hit }}
        run: |
          embuilder.py build --pic ogg
          embuilder.py build --pic vorbis
          embuilder.py build --pic libpng
          embuilder.py build --pic freetype
          embuilder.py build --pic harfbuzz

      - name: Cache Build result
        id: cache_siv3d_library_pic
        uses: actions/cache@v1
        env:
          cache-name: cache-siv3d-library-pic
        with:
          path: Web/build
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('Siv3D/**/*.*') }}-${{ hashFiles('Web/CMakeLists.txt') }}

      - name: Build project
        if: ${{ !steps.cache_siv3d_library_pic.outputs.cache-hit }}
        working-directory: Web/build
        run: cmake --build . --parallel 4 

      - name: Bundle output
        run: |
          mkdir Package
          cp -r Siv3D/include Package
          cp -r Siv3D/lib/Web Package
          cp -r Web/App/resources Package
          cp -r Web/App/example Package
          mv Package/Web Package/lib
          cp Web/build/Siv3D.wasm Package/lib
          cp Web/App/Siv3D.js Package/lib
          zip -r OpenSiv3D.zip Package
          tar -cvzf OpenSiv3D.tgz Package/*

      - name: Save Bundles
        uses: actions/upload-artifact@v2
        with:
          name: OpenSiv3D-Bundles-PIC
          path: OpenSiv3D.*

  build-app-pic:
    needs: build-pic
    container: 
      image: trzeci/emscripten:1.39.13-upstream
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Create build folder
        working-directory: Web/App
        run: mkdir build

      - name: Restore emscripten ports
        id: cache_emscripten_ports
        uses: actions/cache@v1
        env:
          cache-name: cache-emscripten-ports-pic
        with:
          path: /emsdk_portable/.data/
          key: ${{ runner.os }}-build-${{ env.cache-name }}

      - name: Restore Bundles
        uses: actions/download-artifact@v2
        with:
          name: OpenSiv3D-Bundles-PIC
          path: .

      - name: Restore Siv3D library
        run: |
          tar -xvf OpenSiv3D.tgz
          mkdir Web/Build
          cp Package/lib/Siv3D.wasm Web/App/build

      - name: Create project using cmake
        working-directory: Web/App/build
        run: emcmake cmake -DSIV3D_BUILD_WITH_SHARED_WASM=1 ..

      - name: Build Siv3d App
        working-directory: Web/App/build
        run: cmake --build .

      - name: Save Bundles
        uses: actions/upload-artifact@v2
        with:
          name: Siv3D_App_PIC
          path: Web/App/build/Siv3D*.*
